---
title: "Cleaning template - COVID-19 Behind Bars Historical Data Cleaning"
author: "Hope Johnson"
date: "10/26/2020"
output: html_document
---

```{r package setup, include=FALSE}
##Define package list
Packages<-c("tidyverse")
.packages = Packages
##Install CRAN packages (if not already installed)
.inst <- .packages %in% installed.packages()
if(length(.packages[!.inst]) > 0) install.packages(.packages[!.inst])
##Load packages into session 
lapply(.packages, require, character.only=TRUE)
```

## Intro & Credits

This script is used to clean one state in the historical data concerning COVID-19 in state and federal prisons. Contributors to the historical data cleaning efforts include Hope Johnson, Michael Everett, Neal Marquez, Chase Hommeyer, Grace DiLaura, and Kalind Parish. Contributors to larger project include Sharon Dolovich, Aaron Littman, Danielle Flores, Poornima Rajeshwar, Victoria Rossi, and many others. 


## Load inputs

Input files: 

* Utilities script
* Historical data
* Date range to clean 
* Facility name look-up table 

```{r load inputs, echo=FALSE}
base_path <- file.path("~", "UCLA", "code", "historical", "historical-data")
data_path <- file.path(base_path, "data", "xlsx")

##Load utilities function
util_path <- file.path(base_path, "R", "0-utilities.R")
source(util_path, local = knitr::knit_global())
##Facility name look-up table
f <- read_xlsx(file.path(data_path,"facility_spellings_091820.xlsx"))
```


```{r load data}
# no filter
df <- load_data(data_path, 
                "101820")
                # filter_state = "Florida") 
df_typed <- type_convert(df) 
df_out <- df_typed %>%
  select(!starts_with("...")) %>%
  select(!starts_with("lots")) %>%
  select(!starts_with("Bad")) %>%
  select(!c("V2", "V4", "V5", "V7", "V8", "V10")) %>%
  select(!c("Facility.", "Coder", "Housing.Type")) %>%
  select_if(~sum(!is.na(.)) > 0) %>% # rm 100% missing cols 
  

# FEDERAL
# If 'State.1' exists:
# - Make "Facility" = "Federal Prison"
# - Make "State" = {LOOKUP 'state.1' acronym --> full state name}

# OHIO
# If 'Residents.Quarantined' exists:
# - Force it as numeric
# - Put entries into 'Residents.Quarantine'

# TEXAS
# If 'Allred' exists:
# - investigate that date. facility name?


# Residents.Confirmed is a character --> has entries with "n/a". convert these to NA

```

Columns that mean the same thing but have slightly different names: 
- Staff.Death, Staff.Deaths
- Staff.Recovered, Staff.Recoveries
- Staff.Quarantined, Staff.Quarantine
- Residents.Recovered, Residents.Recoveries
- Resident.Death, Residents.Deaths, Resident.Deaths..Confirmed., {? Resident.Deaths..Presumed.}
- Resident.Tested, Residents.Tested
- Inmates.Positive, Residents.Positive

```{r combine similar columns}
allred <- (subset(df_out, !is.na(df_out$Allred)))
```


```{r standardize facility names}
id_xwalk <- f %>%
  select(Count.ID, State, City, facility_name_raw, facility_name_clean) %>%
  unique()
df_mid <-left_join(df_out, id_xwalk, 
                   by = c("Name" = "facility_name_raw", 
                          "State" = "State"))


```


```{r filter columns}

```




