---
title: "Historical Data Monitoring"
author: "Hope Johnson, Neal Marquez"
output: html_document
---

## The UCLA COVID-19 Behind Bars Scraper

```{r load packages warning=FALSE, message=FALSE, echo=FALSE}
##Define package list
library(behindbarstools)
Packages<-c("tidyverse", "plotly", "glue")
.packages = Packages
##Install CRAN packages (if not already installed)
.inst <- .packages %in% installed.packages()
if(length(.packages[!.inst]) > 0) install.packages(.packages[!.inst])
##Load packages into session 
lapply(.packages, require, character.only=TRUE)
##Load utilities function
base_path <- file.path("~", "UCLA", "code", "historical", "historical-data")
util_path <- file.path(base_path, "R", "0-utilities.R")
source(util_path, local = knitr::knit_global())
```


```{r load historical data}
data_path = file.path(base_path, "data")
## Available states for historical data monitoring
(clean_states = list.files(path = data_path, pattern = "*.csv"))

# eventually, cycle through these to create reports? 
state_to_clean = clean_states[4]

hist_data <- read_csv(file.path(data_path, state_to_clean))
```

## Scraper Details

```{r warning=FALSE, message=FALSE, echo=FALSE}
prison_n <- hist_data %>%
    filter(jurisdiction != "Jail",
           jurisdiction != "county") %>%
    pull(Name) %>%
    unique() %>%
    length()

jail_n <- hist_data %>%
    filter(jurisdiction == "Jail" | 
           jurisdiction == "county") %>%
    pull(Name) %>%
    unique() %>%
    length()

fac_rep_deaths <- hist_data %>%
  filter_statewide_NA(Residents.Deaths) %>%
  group_by(Name) %>%
  summarize(cumulative_deaths = last(Residents.Deaths, order_by = Date))

fac_rep_cases <- hist_data %>%
  filter_statewide_NA(Residents.Confirmed) %>%
  group_by(Name) %>%
  summarize(cumulative_cases = last(Residents.Confirmed, order_by = Date)) 

fac_cases_deaths <- fac_rep_cases %>%
  full_join(fac_rep_deaths)

max_cases = max(fac_cases_deaths$cumulative_cases, na.rm = TRUE)
max_deaths = max(fac_cases_deaths$cumulative_deaths, na.rm = TRUE)
  
```

This data is from `r unique(hist_data$State)`. We have been collecting data from `r min(hist_data$Date)` until `r max(hist_data$Date)`. We have collected information for `r prison_n` prisons throughout the state. In addition, we have collected data from `r jail_n` jails. For the purposes of this report, we ignore Federal Prisons located within `r unique(hist_data$State)`. 

The facility in `r unique(hist_data$State)` with the highest number of cumulative cases over the course of the pandemic is `r fac_cases_deaths$Name[fac_cases_deaths$cumulative_cases == max_cases]`. This facility has had `r max_cases` cases total.  

The facility in `r unique(hist_data$State)` with the highest number of cumulative deaths over the course of the pandemic is `r fac_cases_deaths$Name[fac_cases_deaths$cumulative_deaths == max_deaths]`. This facility has had `r max_deaths` cases total.  

```{r warning=FALSE, message=FALSE, echo=FALSE}
fac_cases_deaths %>%
    datatable()
```

## Testing

We collect testing information when available. Up until ~November 2020, the testing numbers we collected could have been the total number of tests administered OR the total number of individuals tested. We did not keep track of which number was being reported by the state. After November 2020, we started collected exclusively the number of tests administered. 

```{r warning=FALSE, message=FALSE, echo=FALSE}
fac_t_admin_n <- hist_data %>%
  get_fac_n(Residents.Tadmin)

fac_res_tested <- hist_data %>%
  get_last_value(Residents.Tested)

fac_res_tested_n <- hist_data %>%
  get_fac_n(Residents.Tested)

# get the last date
# use the population for that date
fac_tested <- hist_data %>%
  filter_statewide_NA(Residents.Tested) %>%
  group_by(Name) %>%
  summarise(last_test_count = last(Residents.Tested, order_by = Date), .groups = "drop") %>%
  ## TO DO: want to get date of last_test_count and population carried over
  # left_join(prison_pop, by = c("State" = "name")) %>%
  mutate(test_rate = last_test_count / Population,
         any_testing = ifelse(is.na(Tests_administered), "No testing", "Some testing")) 

map_df <- usa_sf("laea") %>%
    select(State = name, geometry) %>%
    left_join(state_tested, by = "State")
    
map_plot <- map_df %>%
    mutate(test_rate_cat = cut(test_rate, c(0,1,2,5,15))) %>%
    ggplot(aes(fill = test_rate_cat, text = State)) +
    geom_sf() +
    theme_void() +
    scale_fill_brewer(
        palette = "Spectral", direction = 1, na.value = "grey50") +
   geom_sf_text(aes(label = abbreviation))

map_plot +
    ggtitle(
        "Incarcerated Population in State Prisons Testing Rate",
        "Grey indicates no reported data") +
    labs(fill = "Test Rate\nPer Resident")

```

We have data on the number of **tests administered** for `r fac_t_admin_n` facilities. We have data on the number of **tests given** (ambiguous definition) for `r fac_res_tested_n` facilities.


Stopped here! 
Up next:
- Week-to-week increase over time --> beeswarm plots 
- Malabahari distance
- Small multiples 










We can also analyze how the incarcerated population is doing with respect to the general population for any given state. Below we plot the infection fatality rate for both the incarcerated population and the general population for each state and DC where confirmed and death data is available. We see that the fatality rate is generally lower although this is largely due to the younger general age of the prison population compared to the general population. Note, however, that there are several significant outliers.

```{R warning=FALSE, message=FALSE, echo=FALSE}
state_deaths <- slist$current_data %>%
    filter(jurisdiction == "state") %>%
    group_by(State) %>%
    summarize(
        IFR = sum_na_rm(Residents.Deaths) / sum_na_rm(Residents.Confirmed),
        .groups = "drop")

sc_plot <- slist$current_state %>%
    mutate(pop_ifr = death/positive) %>%
    mutate(State = translate_state(state)) %>%
    select(pop_ifr, State) %>%
    right_join(state_deaths, by = "State") %>%
    rename(`State IFR` = pop_ifr, `Prison IFR` = IFR) %>%
    ggplot(aes(x = `State IFR`, y = `Prison IFR`, text = State)) +
    geom_point() +
    geom_abline() +
    theme_classic() +
    labs(x = "State IFR", y = "Incarcerated Population IFR") +
    ggtitle("Infection Fatality Rate Comparison") +
    ylim(c(0, .07)) +
    xlim(c(0, .07))

ggplotly(sc_plot)

```

Below, we compare infection rates in the general population to the incarcerated population (by facility). This allows us to highlight which carceral facilities diverge most from the state-wide infection rate.

```{r warning=FALSE, message=FALSE, echo=FALSE}
facilities <- slist$hist_data %>%
  mutate(Date = lubridate::mdy(Date)) %>%
  filter(jurisdiction == "state") %>%
  group_by(State, Name) 

## !this is buggy
percentage_change <- facilities %>%
    mutate(
        ten_days_ago = dplyr::lag(Residents.Confirmed, n = 10, order_by = Date),
        ten_day_change = (Residents.Confirmed - ten_days_ago) / (ten_days_ago + 0.00001) 
    ) %>%
    dplyr::arrange(desc(Date)) %>%
    filter(!is.infinite(ten_day_change)) %>%  
    slice_head(n = 1) %>%
    select(Name, State, Date, Residents.Confirmed, ten_days_ago, ten_day_change) %>%
    ungroup() %>%
    mutate(StateFull = behindbarstools::translate_state(State))

## get top 3 facilities per state
top_three_wide <- percentage_change %>%
    group_by(State) %>%
    dplyr::arrange(desc(ten_day_change)) %>%
    filter(!is.na(ten_day_change),
           Residents.Confirmed > 1) %>%
    slice_head(n = 3) %>%
    ungroup()

top_three_long <- top_three_wide %>%
  rename(`Number infected (ten days ago)` = ten_days_ago,
         `Number infected (today)` = Residents.Confirmed) %>%
  pivot_longer(cols = c(`Number infected (ten days ago)`, `Number infected (today)`),
               names_to = "Residents Infected")

## get top five states (avg increase)
top_five_states <- top_three_wide %>%
  group_by(State) %>%
  mutate(avg_inc = mean(ten_day_change)) %>%
  ungroup() %>%
  dplyr::arrange(desc(avg_inc)) %>%
  distinct(State) %>%
  slice_head(n = 5) %>%
  pull(State)

## make plots
plot_bars_by_state <- function(dat, xvar, yvar, grpvar) {
  plots <- dat %>% 
    group_by(State) %>% 
    do(plot=ggplot(data=.) +
           aes_string(x = xvar, y = yvar, fill = grpvar) + 
           geom_bar(stat = "identity", position = position_dodge()) + 
           labs(title = glue('Prison COVID Infections in {unique(.$State)}'),
                subtitle = "Rate of change in number of incarcerated individuals infected (past 10 days)",
                x ="", y = "") + 
         geom_text(aes_string(label=yvar), vjust=1.6, color="white",
                   position = position_dodge(0.9), size=3.5) + 
           scale_fill_brewer(palette="Paired")
       )
  return(plots)
}

plots <- top_three_long %>%
    filter(State %in% top_five_states) %>%
    plot_bars_by_state(., xvar = "Name", yvar = "value", grpvar = "`Residents Infected`")
plots$plot
```

## Historical Data

A strength of our dataset compared to other groups who collect similar data, is that we not only collect information on state level aggregates but also facility level data. This enables us to act as a surveillance mechanism, tracking outbreaks at facilities. Below we see an example of an outbreak occurring within facilities with major outbreaks in the past week.

```{r warning=FALSE, message=FALSE, echo=FALSE}
fac_delta_df <-  slist$hist_data %>%
    mutate(Date = lubridate::mdy(Date)) %>%
    filter(!(str_detect(Name, "(?i)state") & str_detect(Name, "(?i)wide"))) %>%
    filter(Date >= (lubridate::as_date((Sys.Date())) - lubridate::days(7))) %>%
    group_by(Name, State, jurisdiction) %>%
    mutate(delta = last(Residents.Confirmed) - first(Residents.Confirmed)) %>%
    ungroup() %>%
    filter(delta %in% head(sort(unique(delta), decreasing = TRUE), n = 4)) %>%
    select(jurisdiction, State, Name) %>%
    unique() %>%
    left_join( slist$hist_data, by = c("jurisdiction", "State", "Name"))

fac_delta_df %>%
    mutate(Date = lubridate::mdy(Date)) %>%
    mutate(Title = str_c(State, ": ", Name)) %>%
    ggplot(aes(x = Date, y = Residents.Confirmed)) +
    geom_line() +
    facet_wrap(~Title) +
    labs(y = "Residents Confirmed") +
    theme_bw() +
    ggtitle(
        "High Outbreak Facilities",
        "Carceral Facilities with Largest Increase In Resident Cases in Past 7 Days"
    ) +
    theme(
        legend.text = element_text(size=13),
        legend.title = element_text(size=15),
        axis.text = element_text(size=13),
        axis.title = element_text(size=15),
        title =  element_text(size=17))
```

## State Outbreak Comparison

```{r}
delta_df <-  slist$hist_data %>%
    filter(jurisdiction == "state") %>%
    group_by(State, Date) %>%
    summarize(Cases = sum(Residents.Confirmed, na.rm = TRUE), .groups = "drop") %>%
    mutate(Date = lubridate::mdy(Date)) %>%
    filter(Date >= (lubridate::as_date((Sys.Date())) - lubridate::days(7))) %>%
    filter(Date == max(Date) | Date == min(Date)) %>%
    group_by(State) %>%
    summarize(
        prison_change = diff(Cases)/first(Cases)*100,
        prison_cases = last(Cases), .groups = "drop") %>%
    arrange(-prison_change)

state_delta_data <- "https://api.covidtracking.com/v1/states/daily.csv" %>%
    read_csv(col_types = cols()) %>%
    mutate(Date = lubridate::ymd(as.character(date))) %>%
    select(Date, state, positive) %>%
    filter(Date >= (lubridate::as_date((Sys.Date())) - lubridate::days(7))) %>%
    filter(Date == max(Date) | Date == min(Date)) %>%
    arrange(state, Date) %>%
    group_by(state) %>%
    summarize(
        pop_change = diff(positive)/first(positive)*100,
        pop_cases = last(positive), .groups = "drop") %>%
    mutate(State = translate_state(state)) %>%
    select(-state) %>%
    right_join(delta_df, by = "State")

chnge_plot <- state_delta_data %>%
  mutate(text = str_c(
    "State: ", State, "\n",
    "State Cases: ", pop_cases, "\n",
    "Prison Cases: ", prison_cases, "\n"
  )) %>%
  ggplot(aes(x = pop_change, y = prison_change, text = text)) +
  geom_point() +
  theme_bw() +
  labs(x = "State Covid Percentage Increases", y = "Prison Covid Percentage Increases")

ggplotly(chnge_plot)

```

## Death Inconsistancies

```{r}
neg_death_df <- slist$hist_data %>%
    select(jurisdiction, State, Name, Date, Residents.Deaths, Staff.Deaths) %>%
    mutate(Date = lubridate::mdy(Date)) %>%
    arrange(jurisdiction, State, Name, Date) %>%
    group_by(jurisdiction, State, Name) %>% 
    mutate(lag_death = Residents.Deaths - lag(Residents.Deaths)) %>%
    mutate(lag_staff_death = Staff.Deaths - lag(Staff.Deaths)) %>%
    mutate(any_neg = any(lag_death < 0 | lag_staff_death < 0, na.rm = TRUE)) %>%
    filter(any_neg) %>%
    ungroup()

# every once in a while we get negative deaths record all instances here
neg_death_df %>%
    select(-Residents.Deaths, -Staff.Deaths, -any_neg) %>%
    mutate(title = str_c(State, ": ", Name)) %>%
    select(-State, -Name, -jurisdiction) %>%
    pivot_longer(lag_death:lag_staff_death) %>%
    ggplot(aes(x = Date, y = value, color = name, linetype = name)) +
    geom_line() +
    facet_wrap(~title)
```