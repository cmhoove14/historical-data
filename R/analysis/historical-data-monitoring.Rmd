---
title: "Historical Data Monitoring"
author: "Hope Johnson, Neal Marquez, Michael Everett, Erika Tyagi"
output: html_document
---

## Introduction

The purpose of this file is to generate a coherent report on the historical data from a given state. We aim to highlight case and death COVID-19 spikes within specific facilities and time periods. This document is a work-in-progress!

```{r load packages, warning=FALSE, message=FALSE, echo=FALSE}
##Define package list
library(behindbarstools)
Packages<-c("tidyverse", "plotly", "glue")
.packages = Packages
##Install CRAN packages (if not already installed)
.inst <- .packages %in% installed.packages()
if(length(.packages[!.inst]) > 0) install.packages(.packages[!.inst])
##Load packages into session 
lapply(.packages, require, character.only=TRUE)
##Load utilities function
base_path <- file.path("~", "UCLA", "code", "historical", "historical-data")
util_path <- file.path(base_path, "R", "0-utilities.R")
source(util_path, local = knitr::knit_global())
```
We are in the process of cleaning historical data, and not all of it is ready to monitor. The available states are:

```{r load historical data, warning=FALSE, message=FALSE, echo=FALSE}
data_path = file.path(base_path, "data")
## Available states for historical data monitoring
(clean_states = list.files(path = data_path, pattern = "*.csv"))

# eventually, cycle through these to create reports? 
state_to_clean = clean_states[4]

hist_data <- read_csv(file.path(data_path, state_to_clean))
```

## Scraper Details

```{r warning=FALSE, message=FALSE, echo=FALSE}
prison_n <- hist_data %>%
    filter(jurisdiction != "Jail",
           jurisdiction != "county") %>%
    pull(Name) %>%
    unique() %>%
    length()

jail_n <- hist_data %>%
    filter(jurisdiction == "Jail" | 
           jurisdiction == "county") %>%
    pull(Name) %>%
    unique() %>%
    length()

fac_rep_deaths <- hist_data %>%
  filter_statewide_NA(Residents.Deaths) %>%
  group_by(Name) %>%
  summarize(cumulative_deaths = last(Residents.Deaths, order_by = Date))

fac_rep_cases <- hist_data %>%
  filter_statewide_NA(Residents.Confirmed) %>%
  group_by(Name) %>%
  summarize(cumulative_cases = last(Residents.Confirmed, order_by = Date)) 

fac_cases_deaths <- fac_rep_cases %>%
  full_join(fac_rep_deaths)

max_cases = max(fac_cases_deaths$cumulative_cases, na.rm = TRUE)
max_deaths = max(fac_cases_deaths$cumulative_deaths, na.rm = TRUE)
  
```

This data is from `r unique(hist_data$State)`. We have been collecting data from `r min(hist_data$Date)` until `r max(hist_data$Date)`. We have collected information for `r prison_n` prisons throughout the state. In addition, we have collected data from `r jail_n` jails. For the purposes of this report, we ignore Federal Prisons located within `r unique(hist_data$State)`. 

The facility in `r unique(hist_data$State)` with the highest number of cumulative cases over the course of the pandemic is `r fac_cases_deaths$Name[fac_cases_deaths$cumulative_cases == max_cases]`. This facility has had `r max_cases` cases total.  

The facility in `r unique(hist_data$State)` with the highest number of cumulative deaths over the course of the pandemic is `r fac_cases_deaths$Name[fac_cases_deaths$cumulative_deaths == max_deaths]`. This facility has had `r max_deaths` deaths total.  

```{r warning=FALSE, message=FALSE, echo=FALSE}
fac_cases_deaths %>%
  arrange(-cumulative_cases)
```

## Testing

We collect testing information when available. Up until ~November 2020, the testing numbers we collected could have been the total number of tests administered OR the total number of individuals tested. We did not keep track of which number was being reported by the state. After November 2020, we started collected exclusively the number of tests administered. 

```{r warning=FALSE, message=FALSE, echo=FALSE}
fac_t_admin_n <- hist_data %>%
  get_fac_n(Residents.Tadmin)

fac_res_tested <- hist_data %>%
  get_last_value(Residents.Tested)

fac_res_tested_n <- hist_data %>%
  get_fac_n(Residents.Tested)

# get the last date
# use the population for that date
fac_tested <- hist_data %>%
  filter_statewide_NA(Residents.Tested) %>%
  group_by(Name) %>%
  mutate(last_test_count = last(Residents.Tested, order_by = Date), .groups = "drop") %>%
  ## TO DO: want to get date of last_test_count and population carried over
  # left_join(prison_pop, by = c("State" = "name")) %>%
  mutate(test_rate = last_test_count / Population) 

# map_df <- usa_sf("laea") %>%
#     select(State = name, geometry) %>%
#     left_join(state_tested, by = "State")
#     
# map_plot <- map_df %>%
#     mutate(test_rate_cat = cut(test_rate, c(0,1,2,5,15))) %>%
#     ggplot(aes(fill = test_rate_cat, text = State)) +
#     geom_sf() +
#     theme_void() +
#     scale_fill_brewer(
#         palette = "Spectral", direction = 1, na.value = "grey50") +
#    geom_sf_text(aes(label = abbreviation))
# 
# map_plot +
#     ggtitle(
#         "Incarcerated Population in State Prisons Testing Rate",
#         "Grey indicates no reported data") +
#     labs(fill = "Test Rate\nPer Resident")

```

We have data on the number of **tests administered** for `r fac_t_admin_n` facilities. We have data on the number of **tests given** (ambiguous definition) for `r fac_res_tested_n` facilities.


Stopped here! 
Up next:
- Week-to-week increase over time --> beeswarm plots 
- Malabahari distance ?
--> Using IFR = Deaths / Cases

Below, we compare infection rates in the general population to the incarcerated population (by facility). This allows us to highlight which carceral facilities diverge most from the state-wide infection rate.

```{r warning=FALSE, message=FALSE, echo=FALSE}
percentage_change <- hist_data %>%
  mutate(case_rate = Residents.Confirmed / Population,
         death_rate = Residents.Deaths / Population) %>%
  group_by(Name) %>%
  mutate(
      lag_cases = dplyr::lag(Residents.Confirmed, order_by = Date),
      lag_deaths = dplyr::lag(Residents.Deaths, order_by = Date),
      lag_case_rate = dplyr::lag(case_rate, order_by = Date),
      lag_death_rate = dplyr::lag(death_rate, order_by = Date),
      delta_cases = Residents.Confirmed - lag_cases,
      delta_deaths = Residents.Deaths - lag_deaths, 
      pch_cases = (Residents.Confirmed - lag_cases) / (lag_cases + 0.000000001),
      pch_deaths = (Residents.Deaths - lag_deaths) / (lag_deaths + 0.000000001),
      rch_cases = case_rate - lag_case_rate, 
      rch_deaths = death_rate - lag_death_rate, 
  ) %>%
  ungroup() %>%
  select(Date, Name, Population,
         Residents.Confirmed, lag_cases, delta_cases, pch_cases, rch_cases,
         Residents.Deaths, lag_deaths,delta_deaths, pch_deaths, rch_deaths,
         ) %>%
  arrange(-delta_cases)

percentage_change
```

## Historical Data

A strength of our dataset compared to other groups who collect similar data, is that we not only collect information on state level aggregates but also facility level data. This enables us to act as a surveillance mechanism, tracking outbreaks at facilities. Below we see an example of an outbreak occurring within facilities with major outbreaks in the past week.

```{r warning=FALSE, message=FALSE, echo=FALSE}
# fac_delta_df <-  slist$hist_data %>%
#     mutate(Date = lubridate::mdy(Date)) %>%
#     filter(!(str_detect(Name, "(?i)state") & str_detect(Name, "(?i)wide"))) %>%
#     filter(Date >= (lubridate::as_date((Sys.Date())) - lubridate::days(7))) %>%
#     group_by(Name, State, jurisdiction) %>%
#     mutate(delta = last(Residents.Confirmed) - first(Residents.Confirmed)) %>%
#     ungroup() %>%
#     filter(delta %in% head(sort(unique(delta), decreasing = TRUE), n = 4)) %>%
#     select(jurisdiction, State, Name) %>%
#     unique() %>%
#     left_join( slist$hist_data, by = c("jurisdiction", "State", "Name"))
# 
# fac_delta_df %>%
#     mutate(Date = lubridate::mdy(Date)) %>%
#     mutate(Title = str_c(State, ": ", Name)) %>%
#     ggplot(aes(x = Date, y = Residents.Confirmed)) +
#     geom_line() +
#     facet_wrap(~Title) +
#     labs(y = "Residents Confirmed") +
#     theme_bw() +
#     ggtitle(
#         "High Outbreak Facilities",
#         "Carceral Facilities with Largest Increase In Resident Cases in Past 7 Days"
#     ) +
#     theme(
#         legend.text = element_text(size=13),
#         legend.title = element_text(size=15),
#         axis.text = element_text(size=13),
#         axis.title = element_text(size=15),
#         title =  element_text(size=17))
```

## State Outbreak Comparison

```{r}
# delta_df <-  slist$hist_data %>%
#     filter(jurisdiction == "state") %>%
#     group_by(State, Date) %>%
#     summarize(Cases = sum(Residents.Confirmed, na.rm = TRUE), .groups = "drop") %>%
#     mutate(Date = lubridate::mdy(Date)) %>%
#     filter(Date >= (lubridate::as_date((Sys.Date())) - lubridate::days(7))) %>%
#     filter(Date == max(Date) | Date == min(Date)) %>%
#     group_by(State) %>%
#     summarize(
#         prison_change = diff(Cases)/first(Cases)*100,
#         prison_cases = last(Cases), .groups = "drop") %>%
#     arrange(-prison_change)
# 
# state_delta_data <- "https://api.covidtracking.com/v1/states/daily.csv" %>%
#     read_csv(col_types = cols()) %>%
#     mutate(Date = lubridate::ymd(as.character(date))) %>%
#     select(Date, state, positive) %>%
#     filter(Date >= (lubridate::as_date((Sys.Date())) - lubridate::days(7))) %>%
#     filter(Date == max(Date) | Date == min(Date)) %>%
#     arrange(state, Date) %>%
#     group_by(state) %>%
#     summarize(
#         pop_change = diff(positive)/first(positive)*100,
#         pop_cases = last(positive), .groups = "drop") %>%
#     mutate(State = translate_state(state)) %>%
#     select(-state) %>%
#     right_join(delta_df, by = "State")
# 
# chnge_plot <- state_delta_data %>%
#   mutate(text = str_c(
#     "State: ", State, "\n",
#     "State Cases: ", pop_cases, "\n",
#     "Prison Cases: ", prison_cases, "\n"
#   )) %>%
#   ggplot(aes(x = pop_change, y = prison_change, text = text)) +
#   geom_point() +
#   theme_bw() +
#   labs(x = "State Covid Percentage Increases", y = "Prison Covid Percentage Increases")
# 
# ggplotly(chnge_plot)

```

## Death Inconsistancies

```{r}
# neg_death_df <- slist$hist_data %>%
#     select(jurisdiction, State, Name, Date, Residents.Deaths, Staff.Deaths) %>%
#     mutate(Date = lubridate::mdy(Date)) %>%
#     arrange(jurisdiction, State, Name, Date) %>%
#     group_by(jurisdiction, State, Name) %>% 
#     mutate(lag_death = Residents.Deaths - lag(Residents.Deaths)) %>%
#     mutate(lag_staff_death = Staff.Deaths - lag(Staff.Deaths)) %>%
#     mutate(any_neg = any(lag_death < 0 | lag_staff_death < 0, na.rm = TRUE)) %>%
#     filter(any_neg) %>%
#     ungroup()
# 
# # every once in a while we get negative deaths record all instances here
# neg_death_df %>%
#     select(-Residents.Deaths, -Staff.Deaths, -any_neg) %>%
#     mutate(title = str_c(State, ": ", Name)) %>%
#     select(-State, -Name, -jurisdiction) %>%
#     pivot_longer(lag_death:lag_staff_death) %>%
#     ggplot(aes(x = Date, y = value, color = name, linetype = name)) +
#     geom_line() +
#     facet_wrap(~title)
```